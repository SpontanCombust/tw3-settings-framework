name: update-doc-and-samples

on:
  push:
    branches: '*'

env:
  CARGO_TERM_COLOR: always

jobs:
  regenerate-samples:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Use Rust stable
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: x86_64-unknown-linux-gnu
          override: true
      - name: Build with Cargo
        run: cargo build --release --target=x86_64-unknown-linux-gnu
        working-directory: settings-parser
      - name: Parse doc example
        run: >
          cargo run --release --  
          "../doc/mod-menu.xml"
          -o="../doc/mod-menu.ws"
          -p="MOD" -p="mod_"
          -m="MyModSettings"
          -v="1.23"
          --option-parsing-mode=enums
        working-directory: settings-parser
      - name: Parse DifficultyMod sample
        run: >
          cargo run --release --  
          "../samples/DifficultyMod/bin/config/r4game/user_config_matrix/pc/SampleDifficultyMod.xml"
          -o="../samples/DifficultyMod/Mods/modSampleDifficultyMod/content/scripts/local/difficulty_mod_base.ws"
          -m="ModDifficultySettingsBase"
          -p="DM"
          --default-preset-keyword="DEFAULT"
          -v="1.1"
          --no-getter
        working-directory: settings-parser
      - name: Parse MonsterOfTheWeek sample
        run: >
          cargo run --release --  
          "../samples/MonsterOfTheWeek/bin/config/r4game/user_config_matrix/pc/SampleMonsterOfTheWeek.xml"
          -o="../samples/MonsterOfTheWeek/Mods/modSampleMonsterOfTheWeek/content/scripts/local/monster_of_the_week_settings.ws"
          -m="MonsterOfTheWeekSettings"
          -p="MOTW"
          -p="motw"
          -v="1.0"
          --option-parsing-mode=enums
        working-directory: settings-parser
      - name: CLI specification
        run: |
          echo  '```' > "../doc/cli_specification.md"
          cargo run --release -- -h >> "../doc/cli_specification.md"
          echo  '```' >> "../doc/cli_specification.md"
        working-directory: settings-parser
      - name: Check for changes in the project
        id: get_changes
        run: echo "changed=$(git status --porcelain | wc -l)" >> $GITHUB_OUTPUT
      - name: Committing changes if there are any
        if: steps.get_changes.outputs.changed != 0
        uses: EndBug/add-and-commit@v7
        with:
          message: "Update doc and samples"
          default_author: github_actions
    